---
title: HTTP协议——历史演变
date: 2017-04-06 16:32:05
categories: [HTTP]
description: HTTP Protocol，协议，blog.wuzhiwei.cn
---
**HTTP协议**是*HyperText Transfer Protocol*（超文本传输协议）的缩写，用于从万维网（World Wide Web，简称WWW）服务器传输超文本到本地浏览器的传送协议。主要规定了客户端和服务器之间的通信格式，默认使用80端口。

HTTP是一个基于TCP/IP通信协议来传递数据（HTML文件、图片文件、查询结果等）。它的发展是*万维网协会*（World Wide Web Consortium）和*Internet工作小组IETF*（Internet Engineering Task Force）合作的结果，（他们）最终发布了一系列的*RFC*，RFC 1945定义了HTTP/1.0版本。其中最著名的就是RFC 2616。RFC 2616定义了今天普遍使用的一个版本——HTTP 1.1。

# 历史演变

## HTTP/0.9
最早版本是**1991年发布的0.9**版。该版本极其简单，只有一个命令`GET`，如`GET /index.html`表示，TCP连接（connection）建立后，客户端向服务器请求（request）网页*index.html*。**协议规定**，服务器*只能回应HTML格式的字符串，不能回应别的格式*。服务器发送完毕，就关闭TCP连接。

## HTTP/1.0
**1996年5月，HTTP/1.0版本**发布，内容大大增加：

1. 可以传送任何格式的内容（图像、视频、二进制文件等）；
2. 除了`GET`命令，还引入了`POST`命令和`HEAD`命令；
3. 请求和响应格式变化，除数据部分还包括头信息（HTTP header）；
4. 新增功能还包括：状态码（status code）、多字符集支持、多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。

### 缺点
HTTP/1.0版的**主要缺点是**，*每个TCP连接只能发送一个请求*。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。

TCP连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢（slow start）。所以，HTTP 1.0版本的性能比较差。随着网页加载的外部资源越来越多，这个问题就愈发突出了。
为了解决这个问题，有些浏览器在请求时，用了一个非标准的`Connection`字段：`Connection: keep-alive`。

这个字段要求服务器不要关闭TCP连接，以便其他请求复用。服务器同样回应这个字段：`Connection: keep-alive`。

一个可以复用的TCP连接就建立了，直到客户端或服务器主动关闭连接。**但是**，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。

## HTTP/1.1
**1997年1月，HTTP/1.1版本发布**，只比 1.0 版本晚了半年。它进一步完善了HTTP协议，一直用到了20年后的今天，直到现在还是最流行的版本。主要变化有：

1. 引入**持久连接（persistent connection）**，即TCP连接默认不关闭，可以被多个请求复用，不用声明`Connection: keep-alive`；
2. 引入了**管道机制（pipelining）**，即在同一个TCP连接里面，客户端可以同时发送多个请求；
3. 新增了许多动词方法：`PUT`、`PATCH`、`HEAD`、`OPTIONS`、`DELETE`；
4. 客户端请求的头信息新增了`Host`字段，用来指定服务器的域名：`Host: www.example.com`。

### 缺点
虽然1.1版允许复用TCP连接，但是*同一个TCP连接里面，所有的数据通信是按次序进行*的。服务器只有处理完一个回应，才会进行下一个回应。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为"队头堵塞"（Head-of-line blocking）。

为了避免这个问题，只有**两种方法**：

一是减少请求数；

二是同时多开持久连接。

这导致了很多的网页优化技巧，比如合并脚本和样式表、将图片嵌入CSS代码、域名分片（domain sharding）等等。如果HTTP协议设计得更好一些，这些额外的工作是可以避免的。

## SPDY协议
2009年，谷歌公开了自行研发的**SPDY协议**，主要解决HTTP/1.1效率不高的问题。这个协议在Chrome浏览器上证明可行以后，就被当作HTTP/2的基础，主要特性都在HTTP/2之中得到继承。

## HTTP/2
**2015年，HTTP/2发布**。它不叫*HTTP/2.0*，是因为标准委员会不打算再发布子版本了，下一个新版本将是*HTTP/3*。

### 二进制协议
HTTP/1.1版的头信息肯定是文本（ASCII编码），数据体可以是文本，也可以是二进制。**HTTP/2则是一个彻底的二进制协议**，头信息和数据体都是二进制，并且统称为"帧"（frame）：*头信息帧*和*数据帧*。

二进制协议的一个**好处是**，可以定义额外的帧。HTTP/2定义了近十种帧，为将来的高级应用打好了基础。如果使用文本实现这种功能，解析数据将会变得非常麻烦，二进制解析则方便得多。

### 多工
HTTP/2复用TCP连接，*在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了"队头堵塞"*。

举例来说，在一个TCP连接里面，服务器同时收到了A请求和B请求，于是先回应A请求，结果发现处理过程非常耗时，于是就发送A请求已经处理好的部分，接着回应B请求，完成后，再发送A请求剩下的部分。这样双向的、实时的通信，就叫做**多工（Multiplexing）**。

### 数据流
因为HTTP/2的数据包是不按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。
HTTP/2将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID一律为*奇数*，服务器发出的，ID为*偶数*。

数据流发送到一半的时候，客户端和服务器都可以发送信号（RST_STREAM帧），取消这个数据流。1.1版取消数据流的唯一方法，就是关闭TCP连接。这就是说，HTTP/2 可以取消某一次请求，同时保证TCP连接还打开着，可以被其他请求使用。

客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。

### 头信息压缩
HTTP协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如`Cookie`和`User Agent`，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。

HTTP/2对这一点做了优化，引入了**头信息压缩机制（header compression）**。一方面，头信息使用*gzip*或*compress*压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。

### 服务器推送
HTTP/2允许服务器未经请求，主动向客户端发送资源，这叫做**服务器推送（server push）**。

常见场景是客户端请求一个网页，这个网页里面包含很多静态资源。正常情况下，客户端必须收到网页后，解析HTML源码，发现有静态资源，再发出静态资源请求。其实，服务器可以预期到客户端请求网页后，很可能会再请求静态资源，所以就主动把这些静态资源随着网页一起发给客户端了。
